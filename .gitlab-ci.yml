include:
  - project: 'fusonic/devops/images/gitlab-ci-tools'
    file: 'dotnet_test.yml'
    ref: '4.0'

stages:
  - build
  - test
  - publish

default:
  interruptible: true

build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:7.0
  before_script:
    # Workaround for SourceLink: See: https://github.com/dotnet/sourcelink/issues/689
    - git config url."https://github.com/fusonic/dotnet-extensions".insteadOf https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/fusonic/devops/dotnet/extensions
  script:
    - dotnet pack -c Release
  artifacts:
    when: on_success
    paths:
      - ./src/*/src/bin/Release/*.nupkg
      - ./src/*/src/bin/Release/*.snupkg

test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:7.0
  extends: .dotnet-test
  services:
    - name: postgres:14.6
      alias: postgres
  variables:
    POSTGRES_PASSWORD: postgres
    BACKEND_SRC_DIR: src/**
    SLN_PATH: Extensions.sln
    ConnectionStrings__Npgsql: Host=postgres;Database=test_npgsql;Username=postgres;Password=postgres
    ConnectionStrings__Hangfire: Host=postgres;Database=test_hangfire;Username=postgres;Password=postgres
    
publish:
  image: mcr.microsoft.com/dotnet/sdk:7.0
  stage: publish
  variables:
    GIT_STRATEGY: none
  script:
    - dotnet nuget push "src/**/src/bin/Release/*.nupkg" -k $Nuget_Key -s https://api.nuget.org/v3/index.json --skip-duplicate
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH =~ /^release\// || $CI_COMMIT_TAG
      when: manual
