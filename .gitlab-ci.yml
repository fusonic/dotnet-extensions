image: mcr.microsoft.com/dotnet/core/sdk:3.1
stages:
    - test
    - build
    - publish

test:
    stage: test
    script:
        - dotnet test Extensions.sln

build:
    stage: build
    script: 
        - dotnet pack -c Release
    artifacts:
        when: on_success
        paths:
            - ./src/*/src/bin/Release/*.nupkg
            - ./src/*/src/bin/Release/*.snupkg

publish:
    variables:
        GIT_STRATEGY: none
    stage: publish
    script:
        - dotnet nuget push "src/**/src/bin/Release/*.nupkg" -k $Nuget_Key -s https://api.nuget.org/v3/index.json --skip-duplicate
    when: manual
    only: 
        - /^release\/.*$/
        - master