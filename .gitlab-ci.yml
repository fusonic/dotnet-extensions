image: mcr.microsoft.com/dotnet/sdk:5.0
stages:
    - test
    - build
    - publish

test:
    stage: test
    script:
         - dotnet test Extensions.sln

build:
    stage: build
    before_script:
        # Workaround for SourceLink: See: https://github.com/dotnet/sourcelink/issues/689
        - git config url."https://github.com/fusonic/dotnet-extensions".insteadOf https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/fusonic/devops/dotnet/extensions
    script:
        - dotnet pack -c Release
    artifacts:
        when: on_success
        paths:
            - ./src/*/src/bin/Release/*.nupkg
            - ./src/*/src/bin/Release/*.snupkg

publish:
    variables:
        GIT_STRATEGY: none
    stage: publish
    script:
        - dotnet nuget push "src/**/src/bin/Release/*.nupkg" -k $Nuget_Key -s https://api.nuget.org/v3/index.json --skip-duplicate
    when: manual
    only: 
        - /^release\/.*$/
        - master