image: mcr.microsoft.com/dotnet/core/sdk:3.0
stages:
    - test
    - build
    - publish

test:
    stage: test
    script:
        - dotnet test Extensions.sln

build:
    stage: build
    script: 
        - dotnet pack -c Release
    artifacts:
        when: on_success
        paths:
            - ./src/*/src/bin/Release/*.nupkg
            - ./src/*/src/bin/Release/*.snupkg

publish:
    stage: publish
    script:
        - dotnet nuget push src/Abstractions/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
        - dotnet nuget push src/AspNetCore.Http/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
        - dotnet nuget push src/Hangfire/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
        - dotnet nuget push src/Validation/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
        - dotnet nuget push src/Validation.Mvc/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
        - dotnet nuget push src/UnitTests/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
        - dotnet nuget push src/UnitTests.Adapters.EntityFrameworkCore/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
        - dotnet nuget push src/UnitTests.Adapters.InMemoryDatabase/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
        - dotnet nuget push src/UnitTests.Adapters.PostgreSql/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
        - dotnet nuget push src/UnitTests.Tools.PostgreSql/src/bin/Release/*.nupkg -k $Nuget_Key -s https://api.nuget.org/v3/index.json || true
    when: manual
    only: 
        - /^release\/.*$/
        - master