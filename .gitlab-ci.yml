include:
  - project: 'fusonic/devops/images/gitlab-ci-tools'
    file: 'dotnet_test.yml'
    ref: '3.1'

stages:
  - build
  - test
  - publish

default:
  interruptible: true

build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:7.0
  before_script:
    # Workaround for SourceLink: See: https://github.com/dotnet/sourcelink/issues/689
    - git config url."https://github.com/fusonic/dotnet-extensions".insteadOf https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/fusonic/devops/dotnet/extensions
  script:
    - dotnet pack -c Release
  artifacts:
    when: on_success
    paths:
      - ./src/*/src/bin/Release/*.nupkg
      - ./src/*/src/bin/Release/*.snupkg

test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:7.0
  extends: .dotnet-test
  services:
    - name: postgres:14.6
      alias: postgres
  variables:
    POSTGRES_PASSWORD: postgres
    BACKEND_SRC_DIR: src/**
    SLN_PATH: Extensions.sln
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: https://fusonic.gitlab.io/-/devops/dotnet/extensions/-/jobs/${CI_JOB_ID}/artifacts/reports/dotnetcoverage/index.html
  script:
    - export TemplateConnectionString="Host=postgres;Database=test;Username=postgres;Password=postgres"
    - dotnet run --project "src/UnitTests.EntityFrameworkCore.Npgsql/template/UnitTests.EntityFrameworkCore.Npgsql.TestDbTemplateCreator.csproj" "${TemplateConnectionString}"
    - !reference [.dotnet-test, script]
    
publish:
  image: mcr.microsoft.com/dotnet/sdk:7.0
  stage: publish
  variables:
    GIT_STRATEGY: none
  script:
    - dotnet nuget push "src/**/src/bin/Release/*.nupkg" -k $Nuget_Key -s https://api.nuget.org/v3/index.json --skip-duplicate
  when: manual
  only:
    - /^release\/.*$/
    - main
